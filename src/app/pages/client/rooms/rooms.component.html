<div class="flex h-screen w-full">
  <!-- Columna izquierda: agregar widgets + JSON -->
  <aside class="w-1/5 bg-gray-100 p-4 border-r border-gray-300 flex flex-col">
    <h2 class="text-lg font-semibold mb-4">Componentes Flutter</h2>
    <div class="space-y-2 mb-6">
      <button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" (click)="addContainer()">
        âž• Container
      </button>
      <button class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700" (click)="addColumn()">
        âž• Column
      </button>
      <button class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700" (click)="addText()">
        âž• Text
      </button>
      <button class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600" (click)="addDropdown()">
        âž• DropdownButton
      </button>
      <button class="w-full bg-gray-800 text-white py-2 rounded hover:bg-gray-900 mb-4"
        (click)="isModalFlutterCodeOpen = true">
        ðŸ§¾ Ver cÃ³digo Flutter
      </button>

    </div>
    <!-- Selector de pantallas -->
    <div class="mb-4">
      <label class="block text-sm font-semibold mb-2">Pantallas</label>
      <div class="flex flex-wrap gap-2 mb-2">
        <button *ngFor="let pantalla of pantallas; let i = index" (click)="changePantalla(i)"
          class="px-2 py-1 rounded border text-sm" [ngClass]="{
        'bg-blue-600 text-white': currentPantalla === i,
        'bg-white text-gray-800': currentPantalla !== i
      }">
          {{ pantalla.name }}
        </button>
      </div>
      <button class="w-full bg-green-600 text-white py-1 rounded hover:bg-green-700" (click)="addPantalla()">
        âž• Nueva Pantalla
      </button>
    </div>

    <h3 class="text-sm font-semibold mb-2">JSON Canvas</h3>
    <pre class="flex-1 text-xs bg-white p-2 rounded overflow-auto whitespace-pre-wrap">
      {{ pantallas[currentPantalla].components | json }}
    </pre>
    <h3 class="text-sm font-semibold mt-4 mb-2">JSON Completo</h3>
    <pre class="flex-1 text-xs bg-white p-2 rounded overflow-auto whitespace-pre-wrap max-h-64">
      {{ getJsonCompleto() }}
    </pre>

  </aside>

  <!-- Canvas central: simulaciÃ³n de pantalla mÃ³vil -->
  <main class="w-3/5 flex justify-center items-center bg-white pt-16" (click)="hideContextMenu()">
    <div #canvas class="relative mt-44 bg-gray-100 border border-black shadow-lg origin-top scale-[0.75]"
      [ngStyle]="{ width: '360px', height: '812px' }" (mousemove)="onMouseMove($event)" (mouseup)="onMouseUp($event)"
      (mouseleave)="onMouseUp($event)">

      <!-- Renderizar componentes de nivel raÃ­z -->
      <ng-container *ngFor="let comp of pantallas[currentPantalla].components">
        <ng-container *ngTemplateOutlet="componentTemplate; context: {$implicit: comp}"></ng-container>
      </ng-container>

      <!-- Context menu -->
      <div *ngIf="contextMenu.visible" class="absolute bg-white shadow-lg border border-gray-200 rounded z-50 py-1"
        [style.left.px]="contextMenu.x" [style.top.px]="contextMenu.y">
        <div class="px-3 py-1 text-sm font-semibold border-b border-gray-200">
          Agregar hijo a {{ contextMenu.targetComponent?.type }}
        </div>
        <div class="py-1">
          <button class="block w-full text-left px-4 py-1 hover:bg-blue-100 text-sm"
            (click)="addChildWidget('Container')">âž• Container</button>
          <button class="block w-full text-left px-4 py-1 hover:bg-blue-100 text-sm"
            (click)="addChildWidget('Column')">âž• Column</button>
          <button class="block w-full text-left px-4 py-1 hover:bg-blue-100 text-sm" (click)="addChildWidget('Text')">âž•
            Text</button>
          <button class="block w-full text-left px-4 py-1 hover:bg-blue-100 text-sm"
            (click)="addChildWidget('DropdownButton')">âž• DropdownButton</button>
        </div>
      </div>
    </div>
  </main>


  <!-- Columna derecha: panel de configuraciÃ³n -->
  <aside class="w-1/5 bg-gray-100 p-4 border-l border-gray-300">
    <h2 class="text-lg font-semibold mb-4">Propiedades</h2>
    <div *ngIf="selectedComponent" class="space-y-4">
      <div>
        <label class="block text-sm font-medium">Tipo</label>
        <div class="mt-1 text-sm bg-gray-200 py-1 px-2 rounded">{{ selectedComponent.type }}</div>
      </div>
      <div *ngIf="selectedComponent.parentId">
        <label class="block text-sm font-medium">Componente padre</label>
        <div class="mt-1 text-sm bg-gray-200 py-1 px-2 rounded">{{ findComponentById(selectedComponent.parentId)?.type
          || 'N/A' }}</div>
      </div>
      <div>
        <label class="block text-sm font-medium">Top (px)</label>
        <input type="number" [(ngModel)]="selectedComponent.top" class="mt-1 block w-full border-gray-300 rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium">Left (px)</label>
        <input type="number" [(ngModel)]="selectedComponent.left" class="mt-1 block w-full border-gray-300 rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium">Width (px)</label>
        <input type="number" [(ngModel)]="selectedComponent.width" class="mt-1 block w-full border-gray-300 rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium">Height (px)</label>
        <input type="number" [(ngModel)]="selectedComponent.height" class="mt-1 block w-full border-gray-300 rounded" />
      </div>
      <div>
        <label class="block text-sm font-medium">Color</label>
        <input type="color" [(ngModel)]="selectedComponent.decoration.color"
          class="mt-1 h-8 w-full p-0 border-0 rounded" />
      </div>
      <div class="flex space-x-2">
        <div class="flex-1">
          <label class="block text-sm font-medium">Border Color</label>
          <input type="color" [(ngModel)]="selectedComponent.decoration.border.color"
            class="mt-1 h-8 w-full p-0 border-0 rounded" />
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium">Border Width</label>
          <input type="number" [(ngModel)]="selectedComponent.decoration.border.width"
            class="mt-1 block w-full border-gray-300 rounded" />
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">Border Radius (px)</label>
        <input type="number" [(ngModel)]="selectedComponent.decoration.borderRadius"
          class="mt-1 block w-full border-gray-300 rounded" />
      </div>
      <div *ngIf="selectedComponent.text !== undefined">
        <label class="block text-sm font-medium">Texto</label>
        <input type="text" [(ngModel)]="selectedComponent.text" class="mt-1 block w-full border-gray-300 rounded" />
      </div>
    </div>
    <div *ngIf="!selectedComponent" class="text-center text-gray-500">Selecciona un widget</div>
  </aside>


  <div *ngIf="isModalFlutterCodeOpen"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white w-11/12 max-w-3xl rounded-lg shadow-lg p-6 relative max-h-[80vh] overflow-auto">
      <h2 class="text-xl font-semibold mb-4">CÃ³digo Flutter generado</h2>
      <pre class="bg-gray-100 p-4 rounded text-sm overflow-auto whitespace-pre-wrap max-h-96">
{{ generarCodigoFlutter() }}
    </pre>
      <button class="absolute top-2 right-2 text-gray-600 hover:text-black"
        (click)="isModalFlutterCodeOpen = false">âœ–</button>
    </div>
  </div>

</div>

<!-- Template recursivo para renderizar componentes y sus hijos -->
<ng-template #componentTemplate let-comp>
  <div class="absolute cursor-move" [ngStyle]="getComponentStyles(comp)" (mousedown)="onMouseDown($event, comp)"
    (click)="selectComponent(comp, $event)" (contextmenu)="onContextMenu($event, comp)">

    <!-- Contenido segÃºn tipo de componente -->
    <ng-container [ngSwitch]="comp.type">
      <span *ngSwitchCase="'Text'" class=" w-full h-full flex items-center justify-center">
        {{ comp.text }}
      </span>
      <select *ngSwitchCase="'DropdownButton'" disabled class="w-full h-full">
        <option>Dropdown</option>
      </select>
      <div *ngSwitchDefault></div>
    </ng-container>

    <!-- Indicator for widget with children -->
    <div *ngIf="comp.children && comp.children.length > 0"
      class="absolute right-0 bottom-0 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"
      style="transform: translate(25%, 25%)">
      {{ comp.children.length }}
    </div>

    <!-- Render children recursively -->
    <ng-container *ngFor="let child of comp.children">
      <ng-container *ngTemplateOutlet="componentTemplate; context: {$implicit: child}"></ng-container>
    </ng-container>
  </div>
</ng-template>