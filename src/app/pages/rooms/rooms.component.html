<div class="flex h-screen w-full">
  <!-- Columna izquierda: agregar widgets -->
  <app-widgets
    *ngIf="!isPreviewMode"
    class="w-1/5 bg-gray-100 p-4 border-r border-gray-300 flex flex-col overflow-auto"
    [isPreviewMode]="isPreviewMode"
    [pages]="pages"
    [currentPantalla]="currentPantalla"
    [selectedComponent]="selectedComponent"
    (addPage)="addPage()"
    (previewModeToggled)="togglePreviewMode()"
    (pantallaChanged)="changePantalla($event)"
    (pageRemoved)="removePage($event)"
  ></app-widgets>

  <!-- Canvas central: simulaci√≥n de pantalla m√≥vil -->
  <main
    class="flex-1 flex justify-center items-center bg-white pt-20 overflow-auto"
    [ngClass]="{ 'w-full': isPreviewMode, 'w-3/5': !isPreviewMode }"
  >
    <div
      #canvas
      class="relative bg-gray-100 border border-black shadow-lg origin-top"
      [ngClass]="{
        'scale-100': isPreviewMode,
        'scale-[0.75] mt-44': !isPreviewMode
      }"
      [ngStyle]="{ width: '360px', height: '812px' }"
      (mousemove)="!isPreviewMode && onMouseMove($event)"
      (mouseup)="!isPreviewMode && onMouseUp($event)"
      (contextmenu)="onRightClick($event, null)"
    >
      <!-- Renderizado recursivo -->
      <ng-container
        *ngFor="
          let comp of pages[
            isPreviewMode ? previewPantallaIndex : currentPantalla
          ].components
        "
      >
        <ng-container
          *ngTemplateOutlet="renderComponent; context: { comp: comp }"
        ></ng-container>
      </ng-container>

      <!-- Men√∫ contextual -->
      <div
        *ngIf="contextMenu.visible"
        id="context-menu"
        [style.left.px]="contextMenu.x"
        [style.top.px]="contextMenu.y"
        class="absolute bg-white border rounded shadow z-[1000] min-w-[180px]"
      >
        <ng-container *ngIf="contextMenu.targetId; else pasteOnlyMenu">
          <button
            (click)="addChild(contextMenu.targetId!)"
            class="block px-4 py-2 hover:bg-gray-100 w-full text-left"
          >
            ‚ûï Agregar hijo
          </button>
          <button
            (click)="addTextChild(contextMenu.targetId!)"
            class="block px-4 py-2 hover:bg-gray-100 w-full text-left"
          >
            üî§ Agregar Text hijo
          </button>

          <button
            (click)="
              copyComponent(
                findComponentById(
                  pages[currentPantalla].components,
                  contextMenu.targetId!
                )!
              )
            "
            class="block px-4 py-2 hover:bg-gray-100 w-full text-left"
          >
            üìÑ Copiar
          </button>
          <button
            (click)="
              cutComponent(
                findComponentById(
                  pages[currentPantalla].components,
                  contextMenu.targetId!
                )!
              )
            "
            class="block px-4 py-2 hover:bg-gray-100 w-full text-left"
          >
            ‚úÇÔ∏è Cortar
          </button>
          <button
            (click)="pasteComponent(contextMenu.targetId!)"
            class="block px-4 py-2 hover:bg-gray-100 w-full text-left"
            [disabled]="!copiedComponent"
          >
            üìã Pegar dentro
          </button>
          <button
            (click)="removeComponent(contextMenu.targetId!)"
            class="block px-4 py-2 hover:bg-gray-100 w-full text-left text-red-600"
          >
            üóëÔ∏è Eliminar
          </button>
        </ng-container>

        <ng-template #pasteOnlyMenu>
          <button
            (click)="pasteComponent(null)"
            class="block px-4 py-2 hover:bg-gray-100 w-full text-left"
            [disabled]="!copiedComponent"
          >
            üìã Pegar aqu√≠
          </button>
        </ng-template>
      </div>

      <!-- Template recursivo -->
      <ng-template #renderComponent let-comp="comp">
        <div
          [class.absolute]="!hasParentLayout(comp)"
          [class.cursor-move]="!isPreviewMode || comp.type !== 'TextField'"
          [ngStyle]="getComponentStyle(comp)"
          (click)="!isPreviewMode && selectComponent(comp, $event)"
          (mousedown)="!isPreviewMode && onMouseDown($event, comp)"
          (click)="
            isPreviewMode && comp.type === 'IconButton' && comp.navigateTo
              ? goToPantalla(comp.navigateTo)
              : null
          "
          (contextmenu)="onRightClick($event, comp); $event.stopPropagation()"
        >
          <ng-container [ngSwitch]="comp.type">
            <!-- Renderizar TextButton -->
            <ng-container *ngSwitchCase="'TextButton'">
              <button
                class="w-full h-full flex items-center justify-center cursor-pointer"
                [ngStyle]="{
                  'background-color': comp.decoration?.color,
                  border: (comp.decoration?.border.width || 0) + 'px solid ' +
                          (comp.decoration?.border.color || '#000'),
                  'border-radius': (comp.decoration?.borderRadius || 0) + 'px',
                  'font-size.px': comp.fontSize+6,
                  color: comp.textColor,
                  'font-family': comp.fontFamily,
                  'text-align': comp.textAlign,
                  'line-height': '0.9',  
                }"
                (click)="
                  !isPreviewMode
                    ? selectComponent(comp, $event)
                    : comp.navigateTo
                    ? goToPantalla(comp.navigateTo)
                    : null
                "
              >
                {{ comp.text }}
              </button>
            </ng-container>

            <!-- Renderizar TEXT -->
            <div
              *ngSwitchCase="'Text'"
              class="w-full h-full flex items-start justify-center overflow-hidden"
            >
              <!-- Remover los estilos del span que sobrescriben getComponentStyle -->
              <span
                [ngStyle]="{
                  'font-size.px': comp.fontSize+1 ,
                  color: comp.textColor || '#000000',
                  'font-family': comp.fontFamily  || 'inherit',
                  'white-space': 'pre-wrap',
                  'text-align': comp.textAlign || 'left',
                  'line-height': '1.4',
                  
                }"
                class="select-text"
                (click)="selectComponent(comp, $event)"
                (mousedown)="!isPreviewMode && onMouseDown($event, comp)"
                >{{ comp.text }}</span
              >
            </div>
            <!------------------------------------------------------------- -->
            <!-- NUEVO: Renderizar DropdownButton -->
            <ng-container *ngSwitchCase="'DropdownButton'">
              <!-- Modo PREVIEW: desplegable real -->

              <ng-container *ngIf="isPreviewMode; else editDropdown">
                <div class="w-full h-full relative">
                  <select
                    class="w-full h-full absolute inset-0"
                    [ngStyle]="{
                      'background-color': 'transparent',
                      border: 'none',
                      padding: '0 0.5rem',
                      'font-size': '1rem',
                      color: '#000',
                      'z-index': '10'
                    }"
                    [(ngModel)]="comp.selectedOption"
                    (ngModelChange)="propiedades.onDropdownChange(comp, $event)"
                    (mousedown)="$event.stopPropagation()"
                    (click)="$event.stopPropagation()"
                  >
                    <option *ngFor="let opt of comp.options" [value]="opt">
                      {{ opt }}
                    </option>
                  </select>
                </div>
              </ng-container>

              <!-- Modo EDICI√ìN: s√≥lo muestra texto, deja pasar clicks al padre -->
              <ng-template #editDropdown>
                <div
                  class="w-full h-full flex items-center justify-center text-sm text-gray-800"
                >
                  {{ comp.selectedOption }}
                </div>
              </ng-template>
            </ng-container>
            <!------------------------------------------------------------- -->
            <!-- Render gen√©rico por defecto (otros tipos) -->
            <!-- renderizado para checkbox -->
            <ng-container *ngSwitchCase="'Checkbox'">
              <!-- Contenedor principal del checkbox -->
              <div
                class="flex w-full h-full items-center justify-center"
                [ngStyle]="{
                  'background-color': 'transparent'
                }"
              >
                <!-- El checkbox visual - USA EL TAMA√ëO ESCALADO DIRECTAMENTE -->
                <div
                  class="relative flex items-center justify-center cursor-pointer flex-shrink-0"
                  [ngStyle]="{
                    'width.px': (comp.checkSize || 24) * (comp.scale || 1),
                    'height.px': (comp.checkSize || 24) * (comp.scale || 1),
                    'background-color': comp.checked
                      ? comp.activeColor || '#FFFF00'
                      : '#ffffff',

                    border:
                      (comp.borderWidth + 6 || 1) +
                      'px solid ' +
                      (comp.borderColor || comp.checkColor || '#FF0000'),
                    'border-radius':
                      comp.borderRadius === 50
                        ? '50%'
                        : (comp.borderRadius || 4) + 'px'
                  }"
                  (click)="
                    isPreviewMode && propiedades.simulateCheckboxClick(comp, $event);
                    $event.stopPropagation()
                  "
                >
                  <!-- El "tick" o check - ESCALADO PROPORCIONALMENTE -->
                  <div
                    *ngIf="comp.checked"
                    class="flex items-center justify-center pointer-events-none"
                    [ngStyle]="{
                      color: comp.checkColor || '#FF0000',
                      'font-size.px':
                        (comp.checkSize || 24) * (comp.scale || 1) * 0.6,
                      'font-weight': 'bold',
                      'line-height': '1'
                    }"
                  >
                    ‚úì
                  </div>
                </div>
              </div>
            </ng-container>
            <!-- renderizado para el TextField -->
            <ng-container *ngSwitchCase="'TextField'">
              <!-- MODO PREVISUALIZACI√ìN: Input funcional (escribible, no se guarda) -->
              <ng-container *ngIf="isPreviewMode; else editTextField">
                <input
                  class="w-full h-full outline-none"
                  [type]="comp.inputType || 'text'"
                  [placeholder]="comp.hintText || 'Ingresa texto aqu√≠'"
                  [disabled]="comp.enabled === false"
                  [maxLength]="comp.maxLength"
                  [value]="getTextFieldPreviewValue(comp.id)"
                  (input)="setTextFieldPreviewValue(comp.id, $event)"
                  [ngStyle]="{
                    'background-color': comp.decoration?.color || '#ffffff',
                    border:
                      (comp.decoration?.border?.width || 1) +
                      'px solid ' +
                      (comp.decoration?.border?.color || '#e0e0e0'),
                    'border-radius':
                      (comp.decoration?.borderRadius || 4) + 'px',
                    'padding-top': comp.labelText ? '20px' : '12px',
                    'padding-bottom': '12px',
                    'padding-left': '12px',
                    'padding-right': '12px',
                    'font-size': (comp.fontSize || 16) + 'px',
                    color: comp.inputTextColor || '#212121',
                    'font-family': comp.fontFamily || 'inherit',
                    cursor: 'text'
                  }"
                  (click)="$event.stopPropagation()"
                  (mousedown)="$event.stopPropagation()"
                  (focus)="$event.stopPropagation()"
                />
              </ng-container>

              <!-- MODO EDICI√ìN: Solo muestra el dise√±o, no es editable -->
              <ng-template #editTextField>
                <div
                  class="w-full h-full flex items-center justify-start cursor-pointer"
                  [ngStyle]="{
                    'background-color': comp.decoration?.color || '#ffffff',
                    border:
                      (comp.decoration?.border?.width || 1) +
                      'px solid ' +
                      (comp.decoration?.border?.color || '#e0e0e0'),
                    'border-radius':
                      (comp.decoration?.borderRadius || 4) + 'px',
                    'padding-top': comp.labelText ? '20px' : '12px',
                    'padding-bottom': '12px',
                    'padding-left': '12px',
                    'padding-right': '12px',
                    'font-size': (comp.fontSize || 16) + 'px',
                    color: comp.hintColor || '#9e9e9e',
                    'font-family': comp.fontFamily || 'inherit'
                  }"
                  (click)="selectComponent(comp, $event)"
                  (mousedown)="!isPreviewMode && onMouseDown($event, comp)"
                >
                  <!-- Mostrar valor actual o placeholder en modo edici√≥n -->
                  {{ comp.hintText || "TextField" }}
                </div>
              </ng-template>
            </ng-container>
          </ng-container>

          <!-- Render hijos recursivamente -->
          <!-- Si el padre tiene childrenLayout, usamos flex -->
          <!-- Si el padre tiene childrenLayout, usamos flex con alineaci√≥n completa -->
          <ng-container *ngIf="comp.childrenLayout; else defaultChildren">
            <div
              [ngStyle]="{
                display: 'flex',
                'flex-direction': comp.childrenLayout,
                'gap.px': comp.gap || 8,
                'justify-content': getFlexJustifyContent(comp),
                'align-items': getFlexAlignItems(comp),
                width: '100%',
                height: '100%',
                'padding-top.px': comp.padding?.top || comp.paddingAll || 0,
                'padding-right.px': comp.padding?.right || comp.paddingAll || 0,
                'padding-bottom.px':
                  comp.padding?.bottom || comp.paddingAll || 0,
                'padding-left.px': comp.padding?.left || comp.paddingAll || 0,
                'box-sizing': 'border-box'
              }"
            >
              <!-- Renderizar solo hijos que NO sean Text en el flujo flex -->
              <ng-container
                *ngFor="let child of getFlexChildren(comp.children)"
              >
                <ng-container
                  *ngTemplateOutlet="renderComponent; context: { comp: child }"
                ></ng-container>
              </ng-container>
            </div>

            <!-- Renderizar elementos Text por separado (fuera del flujo flex) -->
            <ng-container
              *ngFor="let textChild of getTextChildren(comp.children)"
            >
              <ng-container
                *ngTemplateOutlet="
                  renderComponent;
                  context: { comp: textChild }
                "
              ></ng-container>
            </ng-container>
          </ng-container>

          <!-- Si no, volvemos al comportamiento original -->
          <ng-template #defaultChildren>
            <ng-container *ngFor="let child of comp.children">
              <ng-container
                *ngTemplateOutlet="renderComponent; context: { comp: child }"
              ></ng-container>
            </ng-container>
          </ng-template>
        </div>
      </ng-template>
    </div>
  </main>

  <!-- Columna derecha: panel de configuraci√≥n -->
  <aside
    *ngIf="!isPreviewMode"
    class="w-1/5 bg-gray-100 p-4 border-l border-gray-300 overflow-auto"
  >
  <app-propiedades
  [roomCode]="roomCode"
  [pages]="pages"
  [currentPantalla]="currentPantalla"
  [selectedComponent]="selectedComponent"
  [pantallaCustomRoute]="pantallaCustomRoute"

></app-propiedades>
  </aside>
</div>
